{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tucanasta ‚Äî Comparador</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Tus estilos -->
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
</head>
<body class="bg-light">

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow-sm">
    <div class="container-fluid">
      <!-- Offcanvas toggler -->
      <button class="btn btn-outline-light me-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasCategorias" aria-controls="offcanvasCategorias">
        ‚ò∞
      </button>

      <a class="navbar-brand d-flex align-items-center" href="{% url 'comparador' %}">
        <img src="{% static 'img/logotucan.png' %}" alt="Tucanasta" class="logo-img me-2">
        <span class="brand-text">Tucanasta</span>
      </a>

      <!-- Search (desktop) -->
      <form class="d-none d-lg-flex ms-auto me-3" method="get" action="{% url 'comparador' %}">
        <div class="input-group">
          <input class="form-control" name="q" value="{{ query }}" placeholder="Buscar productos..." aria-label="Buscar">
          <button class="btn btn-success" type="submit">üîç</button>
        </div>
      </form>

      <!-- User -->
      <div class="ms-2">
        {% if user.is_authenticated %}
        <div class="dropdown"></div>
            <button class="btn btn-outline-light dropdown-toggle" type="button" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false">
              üë§ {{ user.username }}
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
              <li><a class="dropdown-item" href="{% url 'ver_cotizacion' %}">Cotizaciones</a></li>
              <li><a class="dropdown-item" href="{% url 'ajustes' %}">Ajustes</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><form method="post" action="{% url 'logout' %}">
                {% csrf_token %}
                <button type="submit" class="dropdown-item">Cerrar sesi√≥n</button>
              </form></li>
            </ul>
        </div>    
        {% else %}
        <a href="{% url 'login' %}" class="btn btn-outline-light">Iniciar sesi√≥n</a>
        {% endif %}
      </div> 
    </div>
  </nav>

  <!-- OFFCANVAS: CATEGOR√çAS -->
  <div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="offcanvasCategorias" aria-labelledby="offcanvasCategoriasLabel">
    <div class="offcanvas-header">
      <h5 id="offcanvasCategoriasLabel">Categor√≠as</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body">
      <div class="list-group list-group-flush">
        <a href="{% url 'comparador' %}" class="list-group-item list-group-item-action bg-dark text-light">Todas</a>
        {% for tipo in tipos %}
          <a href="{% url 'productos_por_categoria' tipo=tipo %}" class="list-group-item list-group-item-action bg-dark text-light {% if tipo == tipo_seleccionado %}active{% endif %}">
            {{ tipo }}
          </a>
        {% empty %}
          <div class="px-3 py-2 text-muted">Sin categor√≠as</div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <main class="container-fluid mt-5 pt-4">
    <!-- mobile search -->
    <div class="row d-lg-none mb-3 px-3">
      <div class="col-12">
        <form method="get" action="{% url 'comparador' %}" class="input-group">
          <input class="form-control" name="q" value="{{ query }}" placeholder="Buscar productos...">
          <button class="btn btn-success" type="submit">üîç</button>
        </form>
      </div>
    </div>

    {% for grupo in data_supermercados %}
      <section class="mb-5">
        <div class="d-flex align-items-center justify-content-between px-3 mb-2">
          <h5 class="mb-0 supermercado-title">{{ grupo.supermercado.nombre }}</h5>
          <a href="{% url 'productos_por_categoria' tipo=grupo.supermercado.nombre %}" class="small text-decoration-none">Ver todo ‚Üí</a>
        </div>

        {% comment %} Aqu√≠ asumimos que `grupo.productos` ya viene filtrado/ordenado (ver nota abajo). {% endcomment %}
        {% if grupo.productos %}
          <div class="position-relative px-3">
            <!-- left control -->
            <button class="carousel-arrow left-arrow d-none d-md-inline-flex" aria-label="Anterior" data-target="#track-{{ forloop.counter }}" data-dir="-1">‚óÄ</button>

            <!-- track: contenedor horizontal -->
            <div id="track-{{ forloop.counter }}" class="productos-track d-flex gap-3 overflow-auto py-2">
              {% for p in grupo.productos %}
                <div class="card product-card" tabindex="0" style="min-width:210px; max-width:220px;">
                  <a class="d-block text-center p-2" href="{{ p.producto_url }}" target="_blank" rel="noopener">
                    <img src="{{ p.imagen_url|default:'/static/img/placeholder.png' }}" alt="{{ p.nombre }}" class="product-img mx-auto" style="height:140px; width:auto;">
                  </a>
                  <div class="card-body p-2 d-flex flex-column" style="min-height:135px;">
                    <h6 class="card-title mb-1 product-name">{{ p.nombre|truncatechars:60 }}</h6>
                    <p class="text-muted small mb-2">{{ p.marca }}</p>
                    <div class="mt-auto d-flex justify-content-between align-items-center">
                      <div class="price text-success fw-bold">${{ p.precio|floatformat:0 }}</div>

                      <!-- Si tienes ruta usar <a href="{% url 'agregar_cotizacion' %}"> -->
                      <button class="btn btn-sm btn-success add-btn" data-product-id="{{ p.id }}">Agregar</button>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>

            <!-- right control -->
            <button class="carousel-arrow right-arrow d-none d-md-inline-flex" aria-label="Siguiente" data-target="#track-{{ forloop.counter }}" data-dir="1">‚ñ∂</button>
          </div>
        {% else %}
          <p class="px-3 text-muted">No hay productos disponibles en {{ grupo.supermercado.nombre }}.</p>
        {% endif %}
      </section>
    {% empty %}
      <p class="px-3 text-muted">No hay productos disponibles.</p>
    {% endfor %}
  </main>

  <footer class="text-center text-muted py-4 mt-4 bg-white">
    ¬© 2025 Tucanasta. Todos los derechos reservados.
  </footer>

  <!-- Bootstrap JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Tiny JS: arrastre + flechas + offcanvas close on click -->
<script>
/* ---------- util: CSRF ---------- */
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

/* ---------- Flechas: scroll del track ---------- */
document.querySelectorAll('.carousel-arrow').forEach(btn => {
  btn.addEventListener('click', () => {
    const target = document.querySelector(btn.dataset.target);
    if (!target) return;
    const card = target.querySelector('.product-card');
    const gap = parseInt(getComputedStyle(target).gap) || 16;
    const step = (card ? card.offsetWidth : 220) + gap;
    const dir = parseInt(btn.dataset.dir, 10) || 1;
    target.scrollBy({ left: dir * step * 2, behavior: 'smooth' }); // mueve 2 tarjetas
  });
});

/* ---------- Drag-to-scroll (mouse + touch) ---------- */
document.querySelectorAll('.productos-track').forEach(track => {
  let isDown = false, startX = 0, scrollLeft = 0;
  track.addEventListener('mousedown', (e) => {
    isDown = true;
    track.classList.add('dragging');
    startX = e.pageX - track.offsetLeft;
    scrollLeft = track.scrollLeft;
  });
  track.addEventListener('mouseleave', () => { isDown = false; track.classList.remove('dragging'); });
  track.addEventListener('mouseup', () => { isDown = false; track.classList.remove('dragging'); });
  track.addEventListener('mousemove', (e) => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - track.offsetLeft;
    const walk = (x - startX) * 1.5;
    track.scrollLeft = scrollLeft - walk;
  });

  // touch
  let touchStartX = 0;
  track.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; });
  track.addEventListener('touchmove', e => {
    const touchX = e.touches[0].clientX;
    const diff = touchStartX - touchX;
    track.scrollLeft += diff;
    touchStartX = touchX;
  });
});

/* ---------- Close offcanvas when clicking a category (UX mobile) ---------- */
document.querySelectorAll('#offcanvasCategorias .list-group-item').forEach(link => {
  link.addEventListener('click', () => {
    const off = bootstrap.Offcanvas.getInstance(document.getElementById('offcanvasCategorias'));
    if (off) off.hide();
  });
});

/* ---------- Handler principal para "Agregar" (POST AJAX seguro) ---------- */
document.querySelectorAll('.add-btn').forEach(b => {
  // evita m√∫ltiples clicks r√°pidos
  let inFlight = false;

  b.addEventListener('click', async (e) => {
    if (inFlight) return;
    inFlight = true;

    const id = b.dataset.productId;
    if (!id) {
      console.error('add-btn sin data-product-id');
      inFlight = false;
      return;
    }

    const prevText = b.innerText;
    b.classList.add('disabled');
    b.innerText = 'Enviando...';

    try {
      const res = await fetch("{% url 'agregar_cotizacion' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
        },
        body: new URLSearchParams({ product_id: id, cantidad: 1 })
      });

      // Si el servidor redirige (por ejemplo al login), fetch normalmente sigue la redirecci√≥n.
      // Si hubo redirecci√≥n, devolveremos al usuario a la URL final (probablemente la p√°gina de login).
      if (res.redirected) {
        // redirige el navegador al destino (login)
        window.location.href = res.url;
        return;
      }

      const contentType = res.headers.get('content-type') || '';
      if (contentType.includes('application/json')) {
        const data = await res.json();
        if (data.ok) {
          // feedback: cambiar texto y actualizar badge si existe
          b.innerText = 'Agregado';
          // si tienes un badge con id="cot-badge", lo incrementamos (si existe)
          const badge = document.getElementById('cot-badge');
          if (badge) {
            const current = parseInt(badge.innerText.replace(/\D/g,'')) || 0;
            badge.innerText = current + 1;
          }
        } else {
          const err = data.error || 'Error desconocido';
          console.warn('Agregar API:', err);
          alert('No se pudo agregar: ' + err);
          b.innerText = prevText;
        }
      } else {
        // respuesta no JSON (debug)
        const text = await res.text();
        console.error('Respuesta inesperada al agregar:', text);
        alert('Respuesta inesperada del servidor. Revisa la consola.');
        b.innerText = prevText;
      }
    } catch (err) {
      console.error('Error de red al agregar:', err);
      alert('Error de red al agregar producto. Intenta de nuevo.');
      b.innerText = prevText;
    } finally {
      // corto delay para que el usuario vea el cambio
      setTimeout(() => {
        b.classList.remove('disabled');
        b.innerText = prevText;
        inFlight = false;
      }, 900);
    }
  });
});
</script>
</body>
</html>
